<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æœé¥°è®¾è®¡åŠ©æ‰‹ (æœ€ç»ˆç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; 
            color: #1f2937;
        }
        .container { max-width: 960px; position: relative; }
        .btn { transition: all 0.2s ease; }
        .btn:hover { transform: translateY(-2px); }
        .btn-primary { background-color: #4f46e5; }
        .btn-primary:hover { background-color: #4338ca; }
        .btn-secondary { background-color: #6b7280; }
        .btn-secondary:hover { background-color: #4b5563; }
        .btn-tertiary { background-color: #dc2626; }
        .btn-tertiary:hover { background-color: #b91c1c; }
        .btn-tertiary:disabled { background-color: #9ca3af; cursor: not-allowed; }
        .btn-quaternary { background-color: #f97316; }
        .btn-quaternary:hover { background-color: #ea580c; }
        .btn-quaternary:disabled { background-color: #fdba74; cursor: not-allowed; }
        .btn-quintenary { background-color: #10b981; }
        .btn-quintenary:hover { background-color: #059669; }
        .btn-sidenary { background-color: #8b5cf6; }
        .btn-sidenary:hover { background-color: #7c3aed; }
        .btn-heptanary { background-color: #0891b2; }
        .btn-heptanary:hover { background-color: #0e7490; }

        #image-container img, #detail-image-container img, #uploaded-image-preview, #i2i-generated-image, #lineart-upload-generated-image {
            max-width: 100%; height: auto; border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .modal { background-color: rgba(0, 0, 0, 0.5); }
        #notebook-toggle, #encyclopedia-toggle {
            position: absolute; top: 1rem; z-index: 20;
        }
        #notebook-toggle { right: 1rem; }
        #encyclopedia-toggle { left: 1rem; }

        .upload-zone { border: 2px dashed #cbd5e1; transition: all 0.2s ease; }
        .upload-zone:hover { border-color: #8b5cf6; background-color: #f5f3ff; }
        .upload-zone.has-image { border-color: #10b981; }

        .spinner {
            display: inline-block;
            animation: spin 1s linear infinite;
            border-radius: 50%;
            width: 2rem; /* 32px */
            height: 2rem; /* 32px */
            border-width: 4px;
            border-color: #d1d5db; /* gray-300 */
            border-top-color: #4f46e5; /* indigo-600 */
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        #notebook-panel {
            position: absolute;
            top: 4.5rem;
            right: 1rem;
        }

        #notebook-header {
            cursor: move;
        }
        
        #auth-modal-overlay { background-color: rgba(0, 0, 0, 0.75); }
        #app-container.blurred { filter: blur(5px); pointer-events: none; }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div id="auth-modal-overlay" class="fixed inset-0 z-40 hidden"></div>
    <div id="auth-modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white p-8 rounded-lg shadow-2xl w-full max-w-sm z-50 hidden">
        <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">æ¬¢è¿ä½¿ç”¨</h2>
        <div class="space-y-4">
            <div>
                <label for="phone-input" class="block text-sm font-medium text-gray-700">æ‰‹æœºå·ç </label>
                <input type="tel" id="phone-input" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="è¯·è¾“å…¥æ‰‹æœºå·">
            </div>
            <div class="flex items-end space-x-2">
                <div class="flex-grow">
                    <label for="code-input" class="block text-sm font-medium text-gray-700">éªŒè¯ç </label>
                    <input type="text" id="code-input" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="è¯·è¾“å…¥4ä½éªŒè¯ç ">
                </div>
                <button id="send-code-btn" class="flex-shrink-0 px-4 py-2 text-white font-semibold rounded-md btn-secondary">å‘é€éªŒè¯ç </button>
            </div>
            <p id="auth-error-msg" class="text-sm text-red-600 text-center h-4"></p>
            <button id="login-btn" class="w-full py-3 px-4 border border-transparent rounded-full shadow-lg text-base font-bold text-white btn-primary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                ç™»å½• / æ³¨å†Œ
            </button>
        </div>
    </div>

    <div id="app-container" class="container mx-auto bg-white p-8 rounded-2xl shadow-2xl space-y-8">
        
        <div id="notebook-toggle" class="p-2 rounded-full hover:bg-gray-100 cursor-pointer">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
        </div>
        
        <div id="encyclopedia-toggle" class="p-2 rounded-full hover:bg-gray-100 cursor-pointer">
             <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v11.494m-9-8.494h18m-18 5.494h18M5 21h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>
        </div>

        <div id="notebook-panel" class="hidden w-72 bg-white/80 backdrop-blur-sm p-4 rounded-lg shadow-lg z-30">
            <div id="notebook-header" class="flex justify-between items-center pb-2 mb-2 border-b border-gray-200">
                 <h3 class="text-lg font-bold text-gray-800">çµæ„Ÿç¬”è®°æœ¬</h3>
                 <span class="text-gray-400" title="å¯æ‹–åŠ¨">âœ¥</span>
            </div>
            <textarea id="notebook-textarea" class="w-full h-48 p-2 border border-gray-200 rounded-md resize-none focus:ring-2 focus:ring-purple-400" placeholder="åœ¨è¿™é‡Œè®°å½•ä½ çš„çµæ„Ÿå…³é”®è¯..."></textarea>
            <div class="flex justify-between items-center mt-2">
                <span id="notebook-status" class="text-sm text-green-600 opacity-0 transition-opacity">å·²ä¿å­˜!</span>
                <div>
                    <button id="notebook-copy-btn" class="px-3 py-1 text-sm font-semibold text-white rounded-full btn btn-secondary">å¤åˆ¶</button>
                    <button id="notebook-clear-btn" class="px-3 py-1 text-sm font-semibold text-white rounded-full btn btn-tertiary">æ¸…ç©º</button>
                </div>
            </div>
        </div>

        <div id="main-page">
            <header class="text-center">
                <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800">AI æœé¥°è®¾è®¡åŠ©æ‰‹ ğŸ‘•</h1>
                <p class="mt-2 text-gray-600">è¾“å…¥ä½ çš„æœè£…è®¾è®¡æƒ³æ³•ï¼Œç”Ÿæˆä¸“ä¸šçš„è®¾è®¡å›¾å’Œè¯´æ˜ã€‚</p>
                <p class="mt-2 text-sm text-gray-500">ä»Šæ—¥å‰©ä½™æ¬¡æ•°: <span id="api-usage-counter">--</span></p>
            </header>
            
            <div class="text-center">
                <button id="go-to-i2i" class="inline-block px-6 py-2 text-white font-bold rounded-full shadow-lg btn-heptanary">åˆ‡æ¢åˆ°å›¾ç”Ÿå›¾æ¨¡å¼ â†’</button>
            </div>

            <section class="space-y-4">
                <div>
                    <label for="prompt-input" class="block text-sm font-medium text-gray-700">
                        è¾“å…¥ä½ çš„æœè£…è®¾è®¡æƒ³æ³•ï¼š
                    </label>
                    <textarea id="prompt-input" rows="4" class="mt-1 block w-full rounded-lg border border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500 transition-colors" placeholder="ä¾‹å¦‚: ä¸€ä»¶èµ›åšæœ‹å…‹é£æ ¼çš„æœªæ¥æ´¾å¤¹å…‹ï¼Œå¸¦æœ‰éœ“è™¹ç¯å¸¦ï¼Œç”±åå…‰é¢æ–™åˆ¶æˆ"></textarea>
                </div>
                
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                    <button id="refine-btn" class="min-w-0 w-full px-4 py-3 border border-transparent rounded-full shadow-lg text-sm sm:text-base font-bold text-white btn btn-tertiary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                        <span>çµæ„Ÿè¯åº“ ğŸ“š</span>
                    </button>

                    <div class="relative min-w-0">
                        <button id="generate-model-btn" class="w-full px-4 py-3 border border-transparent rounded-full shadow-lg text-sm sm:text-base font-bold text-white btn btn-primary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            <span>ç”Ÿæˆæ¨¡ç‰¹ ğŸ§</span>
                        </button>
                        <div id="model-options" class="absolute top-full mt-2 w-56 bg-white rounded-md shadow-lg z-10 hidden origin-top-right right-0">
                            <div class="py-1">
                                <div class="px-4 py-2 text-xs text-gray-400">æ‰‹ç»˜è®¾è®¡å›¾æ¨¡ç‰¹</div>
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-model-type="sketch-asian">äºšæ´²æ¨¡ç‰¹</a>
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-model-type="sketch-black">éæ´²æ¨¡ç‰¹</a>
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-model-type="sketch-european">æ¬§æ´²æ¨¡ç‰¹</a>
                                <div class="border-t border-gray-100 my-1"></div>
                                <div class="px-4 py-2 text-xs text-gray-400">çœŸäººæ¨¡ç‰¹</div>
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-model-type="photo-asian">äºšæ´²æ¨¡ç‰¹</a>
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-model-type="photo-black">éæ´²æ¨¡ç‰¹</a>
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-model-type="photo-european">æ¬§æ´²æ¨¡ç‰¹</a>
                                <div class="border-t border-gray-100 my-1"></div>
                                <a href="#" id="custom-model-btn" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 font-bold">è‡ªå®šä¹‰æ¨¡ç‰¹...</a>
                            </div>
                        </div>
                    </div>
                    
                    <button id="generate-btn" class="min-w-0 w-full px-4 py-3 border border-transparent rounded-full shadow-lg text-sm sm:text-base font-bold text-white btn btn-quaternary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500" disabled>
                        <span>ç”Ÿæˆè®¾è®¡å›¾ âœ¨</span>
                    </button>
                    <button id="lineart-btn" class="min-w-0 w-full px-4 py-3 border border-transparent rounded-full shadow-lg text-sm sm:text-base font-bold text-white btn btn-sidenary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">
                        <span>è®¾è®¡çº¿ç¨¿ âœ’ï¸</span>
                    </button>
                </div>
            </section>

            <section class="space-y-4">
                <div id="result-container" class="space-y-4">
                    <div id="main-loading-container" class="text-center py-8 hidden">
                        <div class="spinner"></div>
                        <p class="mt-2 text-sm font-medium text-gray-600">æ­£åœ¨åŠ è½½...</p>
                    </div>

                    <div id="image-container" class="w-full h-auto flex justify-center items-center relative">
                        <img id="generated-image" class="hidden" alt="Generated AI Image">
                    </div>

                    <div id="model-modification-container" class="hidden text-center mt-4 space-y-3">
                        <button id="show-modify-model-input-btn" class="px-6 py-2 text-white font-bold rounded-full shadow-lg btn-heptanary">ä¿®æ”¹æ¨¡ç‰¹å›¾ ğŸ¨</button>
                        <div id="modify-model-input-area" class="hidden w-full max-w-lg mx-auto space-y-2">
                            <textarea id="modify-model-prompt" rows="2" class="w-full rounded-lg border border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="ä¾‹å¦‚ï¼šç»™æ¨¡ç‰¹æ¢ä¸Šçº¢è‰²é•¿å‘ï¼Œç©¿ä¸Šçš®å¤¹å…‹"></textarea>
                            <button id="submit-model-modification-btn" class="w-full sm:w-auto px-6 py-2 text-white font-bold rounded-full shadow-lg btn-quintenary">ç”Ÿæˆä¿®æ”¹å›¾</button>
                        </div>
                    </div>
                    
                    <div id="detail-image-container" class="w-full h-auto flex justify-center items-center mt-4">
                        <div class="relative w-full">
                             <div id="detail-loading-container" class="text-center py-8 hidden">
                                <div class="spinner"></div>
                                <p class="mt-2 text-sm font-medium text-gray-600">æ­£åœ¨ç”Ÿæˆä¿®æ”¹å›¾...</p>
                            </div>
                            <img id="detail-image" class="hidden mx-auto" alt="Detailed AI Image">
                        </div>
                    </div>

                    <div id="story-buttons-container" class="flex flex-col space-y-2 mt-4 hidden">
                        <label for="story-prompt-input" class="block text-sm font-medium text-gray-700">
                            è®¾è®¡è¯´æ˜æŒ‡ä»¤ (å¯ç¼–è¾‘)ï¼š
                        </label>
                        <textarea id="story-prompt-input" rows="2" class="w-full rounded-lg border border-gray-300 shadow-sm p-3 story-prompt-textarea focus:border-indigo-500 focus:ring-indigo-500 transition-colors"></textarea>
                        <div class="flex flex-col sm:flex-row justify-center space-y-2 sm:space-y-0 sm:space-x-2 mt-4 relative">
                            <button id="story-btn" class="w-full sm:w-auto px-6 py-3 border border-transparent rounded-full shadow-lg text-base sm:text-lg font-bold text-white btn-tertiary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500" disabled>
                                <span>ç”Ÿæˆè®¾è®¡è¯´æ˜ âœ¨</span>
                            </button>
                            <button id="detail-btn" class="w-full sm:w-auto px-6 py-3 border border-transparent rounded-full shadow-lg text-base sm:text-lg font-bold text-white btn-quintenary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500" disabled>
                                <span>æ·±åŒ–è®¾è®¡ç»†èŠ‚ ğŸ”¬</span>
                            </button>
                            <div id="detail-options" class="absolute top-full mt-2 w-full sm:w-auto bg-white rounded-md shadow-lg z-10 hidden">
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 font-bold" data-detail-prompt="custom">æ›´å¤šç»†èŠ‚... (æ‰‹åŠ¨è¾“å…¥)</a>
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-detail-prompt="Show a macro close-up of the fabric texture.">æ”¾å¤§é¢æ–™ç»†èŠ‚</a>
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-detail-prompt="Show the back view of this garment.">å±•ç¤ºæœè£…èƒŒé¢</a>
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-detail-prompt="Show the side profile of this garment.">å±•ç¤ºæœè£…ä¾§é¢</a>
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-detail-prompt="Show this garment on a runway model.">å±•ç¤ºæ¨¡ç‰¹ä¸Šèº«æ•ˆæœ</a>
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-detail-prompt="Show this garment flat lay.">å±•ç¤ºæœè£…å¹³é“ºå›¾</a>
                            </div>
                        </div>
                    </div>

                    <div id="story-container" class="p-4 bg-gray-50 border border-dashed border-gray-300 rounded-lg hidden">
                        <p class="text-sm font-medium text-gray-700">è®¾è®¡è¯´æ˜ï¼š</p>
                        <p id="story-text" class="mt-1 text-gray-900 leading-relaxed whitespace-pre-wrap"></p>
                        <div id="story-action-buttons" class="flex justify-center mt-4 hidden">
                            <button id="copy-story-btn" class="px-6 py-2 text-sm font-bold text-white rounded-full shadow-lg btn-secondary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                                ä¸€é”®å¤åˆ¶
                            </button>
                        </div>
                    </div>

                    <div id="error-message" class="p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg hidden">
                        <p id="error-text" class="text-sm font-medium"></p>
                    </div>
                </div>
            </section>
        </div>

        <div id="i2i-page" class="hidden">
             <header class="text-center">
                <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800">å›¾ç”Ÿå›¾å·¥ä½œå®¤ ğŸ–¼ï¸</h1>
                <p class="mt-2 text-gray-600">ä¸Šä¼ æ¨¡ç‰¹ä¸æœè£…ï¼Œä¸€é”®ç”Ÿæˆç©¿æ­æ•ˆæœå›¾ã€‚</p>
            </header>
            <div class="text-center mt-4">
                <button id="go-to-main" class="inline-block px-6 py-2 text-white font-bold rounded-full shadow-lg btn-secondary">â† è¿”å›æ–‡æœ¬åˆ›ä½œæ¨¡å¼</button>
            </div>
            <section id="image-to-image-section" class="space-y-6 pt-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="w-full">
                        <p class="text-center font-semibold text-gray-700 mb-2">1. ä¸Šä¼ æ¨¡ç‰¹å›¾</p>
                        <label for="i2i-model-upload-input" class="block text-center p-6 rounded-lg cursor-pointer upload-zone">
                            <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                            <span class="mt-2 block text-sm font-medium text-gray-600">ç‚¹å‡»ä¸Šä¼ æ¨¡ç‰¹</span>
                        </label>
                        <input type="file" id="i2i-model-upload-input" class="hidden" accept="image/*">
                        <div id="i2i-model-preview-container" class="hidden text-center mt-4">
                             <img id="i2i-model-preview" class="mx-auto" style="max-height: 200px; width: auto;" alt="Model Preview">
                        </div>
                    </div>
                     <div class="w-full">
                        <p class="text-center font-semibold text-gray-700 mb-2">2. ä¸Šä¼ æœè£…å›¾</p>
                        <label for="i2i-garment-upload-input" class="block text-center p-6 rounded-lg cursor-pointer upload-zone">
                            <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                            <span class="mt-2 block text-sm font-medium text-gray-600">ç‚¹å‡»ä¸Šä¼ æœè£…</span>
                        </label>
                        <input type="file" id="i2i-garment-upload-input" class="hidden" accept="image/*">
                         <div id="i2i-garment-preview-container" class="hidden text-center mt-4">
                             <img id="i2i-garment-preview" class="mx-auto" style="max-height: 200px; width: auto;" alt="Garment Preview">
                        </div>
                    </div>
                </div>

                <div class="w-full max-w-md mx-auto space-y-4">
                    <button id="try-on-btn" class="w-full py-3 px-4 border border-transparent rounded-full shadow-lg text-base font-bold text-white btn btn-quintenary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500" disabled>ä¸€é”®ç©¿æ­ ğŸ‘•</button>
                    
                    <div id="i2i-generated-image-container" class="hidden text-center">
                         <div class="space-y-6">
                            <div id="i2i-before-container" class="hidden w-full relative">
                                <img id="i2i-before-image" class="mx-auto rounded-lg shadow-md" alt="Original Try-on Image">
                            </div>
                            <div id="i2i-after-container" class="w-full relative">
                                <div id="i2i-loading-container" class="text-center py-8 hidden">
                                    <div class="spinner"></div>
                                    <p class="mt-2 text-sm font-medium text-gray-600">æ­£åœ¨åŠ è½½...</p>
                                </div>
                                <img id="i2i-generated-image" class="mx-auto rounded-lg shadow-md" alt="Generated Image">
                            </div>
                            <div id="i2i-modification-buttons" class="w-full flex flex-col items-center gap-2">
                                <button id="modify-try-on-btn" class="hidden w-full sm:w-auto px-6 py-3 border border-transparent rounded-full shadow-lg text-base font-bold text-white btn-heptanary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-cyan-500">
                                    <span>ä¿®æ”¹æ•ˆæœå›¾ ğŸ¨</span>
                                </button>
                                <button id="generate-copy-btn" class="hidden w-full sm:w-auto px-6 py-3 border border-transparent rounded-full shadow-lg text-base font-bold text-white btn-sidenary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">
                                    <span>ç”Ÿæˆæ–‡æ¡ˆ âœï¸</span>
                                </button>
                            </div>
                            <div id="copy-display-container" class="hidden p-4 bg-gray-50 border border-dashed border-gray-300 rounded-lg text-left">
                                <div class="flex justify-between items-center mb-2">
                                     <p class="text-sm font-medium text-gray-700">ç”Ÿæˆæ–‡æ¡ˆï¼š</p>
                                     <button id="copy-generated-text-btn" class="px-3 py-1 text-sm font-semibold text-white rounded-full btn btn-secondary">å¤åˆ¶</button>
                                </div>
                                <p id="generated-copy-text" class="mt-1 text-gray-900 leading-relaxed whitespace-pre-wrap"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
        
        <div id="vocab-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-2xl bg-white space-y-6">
                <div class="flex justify-between items-center pb-3">
                    <h3 class="text-2xl font-bold text-gray-900">æœé¥°è®¾è®¡çµæ„Ÿè¯åº“</h3>
                    <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
                </div>
                <div class="space-y-4">
                    <h4 class="text-lg font-semibold text-gray-700 cursor-pointer hover:text-indigo-600 transition-colors" data-target="style-type-buttons">æ¬¾å¼ç±»åˆ« (Garment Type)</h4>
                    <div id="style-type-buttons" class="flex flex-wrap gap-2 hidden"></div>
                </div>
                <div class="space-y-4">
                    <h4 class="text-lg font-semibold text-gray-700 cursor-pointer hover:text-indigo-600 transition-colors" data-target="aesthetic-buttons">è®¾è®¡é£æ ¼ (Aesthetic)</h4>
                    <div id="aesthetic-buttons" class="flex flex-wrap gap-2 hidden"></div>
                </div>
                <div class="space-y-4">
                    <h4 class="text-lg font-semibold text-gray-700 cursor-pointer hover:text-indigo-600 transition-colors" data-target="material-buttons">é¢æ–™æè´¨ (Material)</h4>
                    <div id="material-buttons" class="flex flex-wrap gap-2 hidden"></div>
                </div>
                <div class="space-y-4">
                    <h4 class="text-lg font-semibold text-gray-700 cursor-pointer hover:text-indigo-600 transition-colors" data-target="pattern-buttons">å›¾æ¡ˆå°èŠ± (Pattern/Print)</h4>
                    <div id="pattern-buttons" class="flex flex-wrap gap-2 hidden"></div>
                </div>
                <div class="space-y-4">
                    <h4 class="text-lg font-semibold text-gray-700 cursor-pointer hover:text-indigo-600 transition-colors" data-target="details-buttons">ç»†èŠ‚å‰ªè£ (Details/Cut)</h4>
                    <div id="details-buttons" class="flex flex-wrap gap-2 hidden"></div>
                </div>
                <div class="space-y-4">
                    <h4 class="text-lg font-semibold text-gray-700 cursor-pointer hover:text-indigo-600 transition-colors" data-target="color-buttons">è‰²å½©æ­é… (Color)</h4>
                    <div id="color-buttons" class="flex flex-wrap gap-2 hidden"></div>
                </div>
            </div>
        </div>

        <div id="custom-detail-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-2xl bg-white space-y-4">
                <div class="flex justify-between items-center"> <h3 class="text-xl font-bold text-gray-900">è¾“å…¥è‡ªå®šä¹‰ä¿®æ”¹æŒ‡ä»¤</h3> <button id="close-custom-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button> </div>
                <div> <textarea id="custom-detail-input" rows="3" class="w-full rounded-lg border border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="ä¾‹å¦‚ï¼šç»™è¿™ä»¶å¤¹å…‹åŠ ä¸Šå…œå¸½"></textarea> </div>
                <div class="flex justify-end"> <button id="submit-custom-detail" class="px-6 py-2 text-white font-bold rounded-full shadow-lg btn-quintenary">ç”Ÿæˆç»†èŠ‚å›¾</button> </div>
            </div>
        </div>
        
        <div id="custom-model-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-2xl bg-white space-y-4">
                <div class="flex justify-between items-center"> <h3 class="text-xl font-bold text-gray-900">è¾“å…¥è‡ªå®šä¹‰æ¨¡ç‰¹ç‰¹å¾</h3> <button id="close-custom-model-btn" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button> </div>
                <div> <textarea id="custom-model-input" rows="3" class="w-full rounded-lg border border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="ä¾‹å¦‚ï¼š25å²äºšæ´²ç”·æ€§ï¼Œèº«æå¥ç¡•ï¼Œæ·±è‰²çš®è‚¤ï¼Œèº«é«˜185cmï¼Œå†™å®ç…§ç‰‡é£æ ¼"></textarea> </div>
                <div class="flex justify-end"> <button id="submit-custom-model" class="px-6 py-2 text-white font-bold rounded-full shadow-lg btn-primary">ç”Ÿæˆæ¨¡ç‰¹</button> </div>
            </div>
        </div>

        <div id="try-on-prompt-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-2xl bg-white space-y-4">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-gray-900">æ·»åŠ ç²¾å‡†æ§åˆ¶æè¿°</h3>
                    <button id="close-try-on-prompt-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
                </div>
                <div>
                    <label for="try-on-prompt-input" class="block text-sm font-medium text-gray-700 mb-1">æè¿°è¯ (é€‰å¡«)</label>
                    <textarea id="try-on-prompt-input" rows="3" class="w-full rounded-lg border border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="ä¾‹å¦‚ï¼šè®©æ¨¡ç‰¹ç«™åœ¨æµ·æ»©èƒŒæ™¯å‰ï¼Œå‚æ™šçš„é˜³å…‰"></textarea>
                </div>
                <div class="flex justify-end">
                    <button id="submit-try-on-prompt" class="px-6 py-2 text-white font-bold rounded-full shadow-lg btn-quintenary">å¼€å§‹ç”Ÿæˆ</button>
                </div>
            </div>
        </div>
        
        <div id="modify-try-on-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-2xl bg-white space-y-4">
                <div class="flex justify-between items-center"> <h3 class="text-xl font-bold text-gray-900">è¾“å…¥ä¿®æ”¹æŒ‡ä»¤</h3> <button id="close-modify-try-on-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button> </div>
                <div> <textarea id="modify-try-on-input" rows="3" class="w-full rounded-lg border border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="ä¾‹å¦‚ï¼šå°†èƒŒæ™¯æ¢æˆè¡—é“ï¼Œå±•ç¤ºä¾§é¢æ•ˆæœ"></textarea> </div>
                <div class="flex justify-end"> <button id="submit-modify-try-on" class="px-6 py-2 text-white font-bold rounded-full shadow-lg btn-heptanary">ç¡®è®¤ä¿®æ”¹</button> </div>
            </div>
        </div>
        
        <div id="generate-copy-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-2xl bg-white space-y-4">
                <div class="flex justify-between items-center">
                     <h3 class="text-xl font-bold text-gray-900">ç”Ÿæˆæ¨å¹¿æ–‡æ¡ˆ</h3>
                     <button id="close-generate-copy-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
                </div>
                <div>
                     <label for="generate-copy-input" class="block text-sm font-medium text-gray-700 mb-1">æ–‡æ¡ˆè¦æ±‚ (é€‰å¡«)</label>
                     <textarea id="generate-copy-input" rows="3" class="w-full rounded-lg border border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="ä¾‹å¦‚ï¼šå°çº¢ä¹¦é£æ ¼ï¼Œçªå‡ºå°‘å¥³æ„Ÿå’Œå¤æ—¥æ¸…å‡‰"></textarea>
                </div>
                <div class="flex justify-end">
                     <button id="submit-generate-copy" class="px-6 py-2 text-white font-bold rounded-full shadow-lg btn-sidenary">ç”Ÿæˆæ–‡æ¡ˆ</button>
                </div>
            </div>
        </div>

        <div id="i2i-custom-detail-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-2xl bg-white space-y-4">
                <div class="flex justify-between items-center"> <h3 class="text-xl font-bold text-gray-900">è¾“å…¥è‡ªå®šä¹‰ä¿®æ”¹æŒ‡ä»¤</h3> <button id="i2i-close-custom-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button> </div>
                <div> <textarea id="i2i-custom-detail-input" rows="3" class="w-full rounded-lg border border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="ä¾‹å¦‚ï¼šæŠŠè¿™ä»¶Tæ¤çš„é¢œè‰²æ”¹æˆé»‘è‰²"></textarea> </div>
                <div class="flex justify-end"> <button id="i2i-submit-custom-detail" class="px-6 py-2 text-white font-bold rounded-full shadow-lg btn-quintenary">ç”Ÿæˆç»†èŠ‚å›¾</button> </div>
            </div>
        </div>

        <div id="lineart-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
             <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-2/3 shadow-lg rounded-2xl bg-white space-y-4 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center">
                    <h3 class="text-2xl font-bold text-gray-900">è®¾è®¡çº¿ç¨¿ç”Ÿæˆå™¨ âœ’ï¸</h3>
                    <button id="close-lineart-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
                </div>
                
                <div class="p-4 border-b border-gray-200">
                    <h4 class="text-xl font-semibold mb-2 text-center">ä»æ–‡æœ¬ç”Ÿæˆçº¿ç¨¿</h4>
                    <div class="flex space-x-2">
                        <input type="text" id="lineart-input" class="flex-grow rounded-full border border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="è¾“å…¥è®¾è®¡ä¸»é¢˜ï¼Œä¾‹å¦‚ï¼šä¸€ä»¶è¿è¡£è£™">
                        <button id="lineart-generate-btn" class="px-6 py-2 text-white font-bold rounded-full shadow-lg btn-sidenary">ç”Ÿæˆçº¿ç¨¿</button>
                    </div>
                </div>
                
                <div id="lineart-loading-container" class="text-center py-8 hidden">
                    <div class="spinner"></div>
                    <p class="mt-2 text-sm font-medium text-gray-600">æ­£åœ¨ç”Ÿæˆçº¿ç¨¿...</p>
                </div>

                <div id="lineart-results" class="space-y-4 p-2 text-center">
                </div>

                <hr class="my-4">

                <div class="p-4">
                    <h4 class="text-xl font-semibold mb-2 text-center">ä¸Šä¼ å›¾ç‰‡å†åˆ›ä½œ</h4>
                     <div class="w-full max-w-md mx-auto">
                        <label for="lineart-upload-input" class="block text-center p-6 rounded-lg cursor-pointer upload-zone">
                            <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                            <span class="mt-2 block text-sm font-medium text-gray-600">ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</span>
                        </label>
                        <input type="file" id="lineart-upload-input" class="hidden" accept="image/*">
                        <div id="lineart-upload-preview-container" class="hidden text-center mt-4">
                             <img id="lineart-upload-preview" class="mx-auto rounded-lg shadow-md" alt="Uploaded Image Preview">
                        </div>
                        <div id="lineart-upload-modification-container" class="hidden w-full max-w-md mx-auto mt-4 space-y-3">
                            <label for="lineart-upload-modification-prompt" class="block text-sm font-medium text-gray-700">è¾“å…¥æè¿°è¯ä¿®æ”¹å›¾ç‰‡ï¼š</label>
                            <textarea id="lineart-upload-modification-prompt" rows="3" class="w-full rounded-lg border border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="ä¾‹å¦‚ï¼šç»™è¿™ä»¶è¡£æœä¸Šè‰²ï¼Œæ·»åŠ æ˜Ÿç©ºå›¾æ¡ˆ"></textarea>
                            <button id="lineart-upload-modify-btn" class="w-full py-2 px-4 border border-transparent rounded-full shadow-lg text-base font-bold text-white btn-heptanary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-cyan-500">ç”Ÿæˆæ–°å›¾ç‰‡</button>
                        </div>
                         <div id="lineart-upload-loading-container" class="text-center py-8 hidden">
                            <div class="spinner"></div>
                            <p class="mt-2 text-sm font-medium text-gray-600">æ­£åœ¨ç”Ÿæˆæ–°å›¾ç‰‡...</p>
                        </div>
                        <div id="lineart-upload-generated-image-container" class="hidden text-center mt-6 relative">
                            <img id="lineart-upload-generated-image" class="mx-auto rounded-lg shadow-md" alt="Generated Image from Upload">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="lineart-custom-detail-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-2xl bg-white space-y-4">
                <div class="flex justify-between items-center"> <h3 class="text-xl font-bold text-gray-900">è¾“å…¥è‡ªå®šä¹‰ä¿®æ”¹æŒ‡ä»¤</h3> <button id="lineart-close-custom-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button> </div>
                <div> <textarea id="lineart-custom-detail-input" rows="3" class="w-full rounded-lg border border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="ä¾‹å¦‚ï¼šç»™è¿™ä»¶è¡£æœä¸Šè‰²"></textarea> </div>
                <div class="flex justify-end"> <button id="lineart-submit-custom-detail" class="px-6 py-2 text-white font-bold rounded-full shadow-lg btn-quintenary">ç”Ÿæˆ</button> </div>
            </div>
        </div>
        
        <div id="encyclopedia-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-2/3 shadow-lg rounded-2xl bg-white space-y-4">
                <div class="flex justify-between items-center">
                    <h3 class="text-2xl font-bold text-gray-900">æ—¶å°šç™¾ç§‘å…¨ä¹¦ ğŸ“–</h3>
                    <button id="close-encyclopedia-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
                </div>
                <div class="flex space-x-2">
                    <input type="text" id="encyclopedia-input" class="flex-grow rounded-full border border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="è¾“å…¥å…³é”®è¯æœç´¢ï¼Œä¾‹å¦‚ï¼šé¦™å¥ˆå„¿">
                    <button id="encyclopedia-search-btn" class="px-6 py-2 text-white font-bold rounded-full shadow-lg btn-primary">æœç´¢</button>
                </div>
                <div id="encyclopedia-loading" class="text-center py-4 hidden">
                    <div class="spinner"></div>
                    <p class="mt-2 text-sm font-medium text-blue-600">æ­£åœ¨æ£€ç´¢ä¿¡æ¯åº“...</p>
                </div>
                <div id="encyclopedia-results" class="space-y-4 max-h-[60vh] overflow-y-auto p-2">
                </div>
            </div>
        </div>

    </div>

    <script type="module">
    // --- Start of Script ---
    
    // ã€é‡è¦ä¿®æ”¹ã€‘å·²å°†æ¨¡å‹åç§°æ›´æ–°ä¸ºæœ€æ–°çš„ç¨³å®šç‰ˆæœ¬
    const API_PROXY_BASE_URL = '/api/generateContent';
    const GEMINI_API_URL = `${API_PROXY_BASE_URL}/gemini-1.5-flash-latest`; // For text
    const IMAGE_GENERATION_API_URL = `${API_PROXY_BASE_URL}/gemini-1.5-flash-latest`; // Also use for images
    
    const DAILY_API_LIMIT = 200; 
    const USAGE_STORAGE_KEY = 'fashionApiUsage'; 
    
    // --- DOM Elements ---
    const apiUsageCounter = document.getElementById('api-usage-counter');
    const mainPage = document.getElementById('main-page');
    const i2iPage = document.getElementById('i2i-page');
    const promptInput = document.getElementById('prompt-input');
    const refineBtn = document.getElementById('refine-btn');
    const generateBtn = document.getElementById('generate-btn');
    const storyBtn = document.getElementById('story-btn');
    const detailBtn = document.getElementById('detail-btn');
    const detailOptions = document.getElementById('detail-options');
    const imageContainer = document.getElementById('image-container');
    const generatedImage = document.getElementById('generated-image');
    const detailImageContainer = document.getElementById('detail-image-container');
    const detailImage = document.getElementById('detail-image');
    const storyContainer = document.getElementById('story-container');
    const storyButtonsContainer = document.getElementById('story-buttons-container');
    const storyText = document.getElementById('story-text');
    const storyPromptInput = document.getElementById('story-prompt-input');
    const copyStoryBtn = document.getElementById('copy-story-btn');
    const errorMessage = document.getElementById('error-message');
    const errorText = document.getElementById('error-text');
    const vocabModal = document.getElementById('vocab-modal');
    const closeModalBtn = document.getElementById('close-modal-btn');
    const customDetailModal = document.getElementById('custom-detail-modal');
    const closeCustomModalBtn = document.getElementById('close-custom-modal-btn');
    const customDetailInput = document.getElementById('custom-detail-input');
    const submitCustomDetailBtn = document.getElementById('submit-custom-detail');
    const encyclopediaModal = document.getElementById('encyclopedia-modal');
    const encyclopediaToggle = document.getElementById('encyclopedia-toggle');
    const closeEncyclopediaModalBtn = document.getElementById('close-encyclopedia-modal-btn');
    const encyclopediaInput = document.getElementById('encyclopedia-input');
    const encyclopediaSearchBtn = document.getElementById('encyclopedia-search-btn');
    const encyclopediaLoading = document.getElementById('encyclopedia-loading');
    const encyclopediaResults = document.getElementById('encyclopedia-results');
    const lineartModal = document.getElementById('lineart-modal');
    const lineartBtn = document.getElementById('lineart-btn');
    const closeLineartModalBtn = document.getElementById('close-lineart-modal-btn');
    const lineartInput = document.getElementById('lineart-input');
    const lineartGenerateBtn = document.getElementById('lineart-generate-btn');
    const lineartResults = document.getElementById('lineart-results');
    const lineartCustomDetailModal = document.getElementById('lineart-custom-detail-modal');
    const lineartCloseCustomModalBtn = document.getElementById('lineart-close-custom-modal-btn');
    const lineartCustomDetailInput = document.getElementById('lineart-custom-detail-input');
    const lineartSubmitCustomDetailBtn = document.getElementById('lineart-submit-custom-detail');
    const lineartUploadInput = document.getElementById('lineart-upload-input');
    const lineartUploadPreviewContainer = document.getElementById('lineart-upload-preview-container');
    const lineartUploadPreview = document.getElementById('lineart-upload-preview');
    const lineartUploadModificationContainer = document.getElementById('lineart-upload-modification-container');
    const lineartUploadModificationPrompt = document.getElementById('lineart-upload-modification-prompt');
    const lineartUploadModifyBtn = document.getElementById('lineart-upload-modify-btn');
    const lineartUploadGeneratedImageContainer = document.getElementById('lineart-upload-generated-image-container');
    const lineartUploadGeneratedImage = document.getElementById('lineart-upload-generated-image');
    const notebookToggle = document.getElementById('notebook-toggle');
    const notebookPanel = document.getElementById('notebook-panel');
    const notebookTextarea = document.getElementById('notebook-textarea');
    const notebookStatus = document.getElementById('notebook-status');
    const notebookCopyBtn = document.getElementById('notebook-copy-btn');
    const notebookClearBtn = document.getElementById('notebook-clear-btn');
    const notebookHeader = document.getElementById('notebook-header');
    const generateModelBtn = document.getElementById('generate-model-btn');
    const modelOptions = document.getElementById('model-options');
    const customModelBtn = document.getElementById('custom-model-btn');
    const customModelModal = document.getElementById('custom-model-modal');
    const closeCustomModelBtn = document.getElementById('close-custom-model-btn');
    const customModelInput = document.getElementById('custom-model-input');
    const submitCustomModelBtn = document.getElementById('submit-custom-model');
    const modelModificationContainer = document.getElementById('model-modification-container');
    const showModifyModelInputBtn = document.getElementById('show-modify-model-input-btn');
    const modifyModelInputArea = document.getElementById('modify-model-input-area');
    const modifyModelPrompt = document.getElementById('modify-model-prompt');
    const submitModelModificationBtn = document.getElementById('submit-model-modification-btn');
    const i2iModelUploadInput = document.getElementById('i2i-model-upload-input');
    const i2iGarmentUploadInput = document.getElementById('i2i-garment-upload-input');
    const i2iModelPreviewContainer = document.getElementById('i2i-model-preview-container');
    const i2iModelPreview = document.getElementById('i2i-model-preview');
    const i2iGarmentPreviewContainer = document.getElementById('i2i-garment-preview-container');
    const i2iGarmentPreview = document.getElementById('i2i-garment-preview');
    const tryOnBtn = document.getElementById('try-on-btn');
    const modifyTryOnBtn = document.getElementById('modify-try-on-btn');
    const generateCopyBtn = document.getElementById('generate-copy-btn');
    const tryOnPromptModal = document.getElementById('try-on-prompt-modal');
    const closeTryOnPromptModalBtn = document.getElementById('close-try-on-prompt-modal-btn');
    const tryOnPromptInput = document.getElementById('try-on-prompt-input');
    const submitTryOnPromptBtn = document.getElementById('submit-try-on-prompt');
    const modifyTryOnModal = document.getElementById('modify-try-on-modal');
    const closeModifyTryOnModalBtn = document.getElementById('close-modify-try-on-modal-btn');
    const modifyTryOnInput = document.getElementById('modify-try-on-input');
    const submitModifyTryOnBtn = document.getElementById('submit-modify-try-on');
    const i2iGeneratedImageContainer = document.getElementById('i2i-generated-image-container');
    const i2iBeforeContainer = document.getElementById('i2i-before-container');
    const i2iBeforeImage = document.getElementById('i2i-before-image');
    const i2iAfterContainer = document.getElementById('i2i-after-container');
    const i2iGeneratedImage = document.getElementById('i2i-generated-image');
    const i2iCustomDetailModal = document.getElementById('i2i-custom-detail-modal');
    const i2iCloseCustomModalBtn = document.getElementById('i2i-close-custom-modal-btn');
    const i2iCustomDetailInput = document.getElementById('i2i-custom-detail-input');
    const i2iSubmitCustomDetailBtn = document.getElementById('i2i-submit-custom-detail');
    const generateCopyModal = document.getElementById('generate-copy-modal');
    const closeGenerateCopyModalBtn = document.getElementById('close-generate-copy-modal-btn');
    const generateCopyInput = document.getElementById('generate-copy-input');
    const submitGenerateCopyBtn = document.getElementById('submit-generate-copy');
    const copyDisplayContainer = document.getElementById('copy-display-container');
    const generatedCopyText = document.getElementById('generated-copy-text');
    const copyGeneratedTextBtn = document.getElementById('copy-generated-text-btn');
    const goToI2IButton = document.getElementById('go-to-i2i');
    const goToMainButton = document.getElementById('go-to-main');
    
    // Auth DOM Elements
    const authModalOverlay = document.getElementById('auth-modal-overlay');
    const authModal = document.getElementById('auth-modal');
    const appContainer = document.getElementById('app-container');
    const phoneInput = document.getElementById('phone-input');
    const codeInput = document.getElementById('code-input');
    const sendCodeBtn = document.getElementById('send-code-btn');
    const loginBtn = document.getElementById('login-btn');
    const authErrorMsg = document.getElementById('auth-error-msg');

    // Loading Containers
    const mainLoadingContainer = document.getElementById('main-loading-container');
    const detailLoadingContainer = document.getElementById('detail-loading-container');
    const i2iLoadingContainer = document.getElementById('i2i-loading-container');
    const lineartLoadingContainer = document.getElementById('lineart-loading-container');
    const lineartUploadLoadingContainer = document.getElementById('lineart-upload-loading-container');

    // --- State Variables ---
    let currentImageData = null;
    let currentLineArtData = null;
    let uploadedLineartImageData = null;
    let uploadedModelData = null;
    let uploadedGarmentData = null;
    let currentTryOnResultData = null; 
    let originalTryOnResultData = null;

    // --- NEW: Authentication Functions ---
    function showLogin() {
        authModalOverlay.classList.remove('hidden');
        authModal.classList.remove('hidden');
        appContainer.classList.add('blurred');
    }

    function hideLogin() {
        authModalOverlay.classList.add('hidden');
        authModal.classList.add('hidden');
        appContainer.classList.remove('blurred');
    }

    async function handleSendCode() {
        const phone = phoneInput.value;
        if (!phone || !/^1[3-9]\d{9}$/.test(phone)) {
            authErrorMsg.textContent = 'è¯·è¾“å…¥æœ‰æ•ˆçš„æ‰‹æœºå·ç ';
            return;
        }
        authErrorMsg.textContent = '';
        sendCodeBtn.disabled = true;
        sendCodeBtn.textContent = 'å‘é€ä¸­...';
        try {
            const response = await fetch('/api/send-code', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ phone })
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error || 'å‘é€å¤±è´¥');
            
            authErrorMsg.textContent = 'éªŒè¯ç å·²å‘é€';
            let countdown = 60;
            const interval = setInterval(() => {
                sendCodeBtn.textContent = `${countdown}s`;
                countdown--;
                if (countdown < 0) {
                    clearInterval(interval);
                    sendCodeBtn.textContent = 'å‘é€éªŒè¯ç ';
                    sendCodeBtn.disabled = false;
                }
            }, 1000);
        } catch (error) {
            authErrorMsg.textContent = error.message;
            sendCodeBtn.textContent = 'å‘é€éªŒè¯ç ';
            sendCodeBtn.disabled = false;
        }
    }

    async function handleLogin() {
        const phone = phoneInput.value;
        const code = codeInput.value;
        if (!phone || !code) {
            authErrorMsg.textContent = 'æ‰‹æœºå·å’ŒéªŒè¯ç ä¸èƒ½ä¸ºç©º';
            return;
        }
        authErrorMsg.textContent = '';
        loginBtn.disabled = true;

        try {
            const response = await fetch('/api/verify-code', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ phone, code })
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error || 'ç™»å½•å¤±è´¥');

            if (result.success && result.token) {
                localStorage.setItem('userToken', result.token);
                hideLogin();
            }
        } catch (error) {
            authErrorMsg.textContent = error.message;
        } finally {
            loginBtn.disabled = false;
        }
    }

    // --- MODIFIED: API Fetcher now includes Auth Token ---
    async function fetchWithRetry(url, options, retries = 3) {
        const token = localStorage.getItem('userToken');
        const headers = {
            'Content-Type': 'application/json',
            ...options.headers,
        };
        
        if (token) {
            headers['Authorization'] = `Bearer ${token}`;
        }
    
        for (let i = 0; i < retries; i++) {
            try {
                const response = await fetch(url, { ...options, headers });
                if (response.status === 401 || response.status === 403) {
                    // Token is invalid or expired, force re-login
                    localStorage.removeItem('userToken');
                    showLogin();
                    throw new Error('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•ã€‚');
                }
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    const errorMessage = errorData.error?.message || `HTTP Error: ${response.status}`;
                    throw new Error(errorMessage);
                }
                return await response.json(); 
            } catch (error) {
                if (i === retries - 1) throw error;
                await new Promise(res => setTimeout(res, 1000 * (i + 1)));
            }
        }
    }

    // --- Core Functions (Largely Unchanged) ---
    const getRandomElement = (arr) => arr[Math.floor(Math.random() * arr.length)];
    function generateRandomizedModelPrompt(modelType) { let prompt = ""; const sketchPoses = ['dynamic walking pose', 'elegant turning pose', 'classic contrapposto stance', 'energetic leaping pose', 'relaxed sitting pose', 'dramatic high fashion pose']; const photoPoses = ['standing confidently', 'walking towards camera', 'leaning against a plain wall', 'sitting on a simple stool', 'a dynamic mid-motion pose', 'a classic studio portrait pose']; const photoExpressions = ['a gentle smile', 'a neutral confident look', 'a joyful laugh', 'a thoughtful gaze', 'a powerful, direct stare', 'a serene expression']; const photoLenses = ['shot on a Canon EOS R5 with 85mm f/1.2 lens', 'shot on a Sony A7R IV with 135mm f/1.8 lens', 'shot on a Hasselblad X2D with 55mm f/2.5 lens', 'shot with a 50mm f/1.4 prime lens', 'captured with a 100mm macro lens for detail']; switch (modelType) { case 'sketch-asian': prompt = `Full body fashion illustration of a chic Asian model in a ${getRandomElement(sketchPoses)}. Expressive, clean, minimalist line art. Plain white background, perfect for a clothing design mockup.`; break; case 'sketch-black': prompt = `Full body fashion illustration of a graceful Black model in a ${getRandomElement(sketchPoses)}. Bold, dynamic, and expressive line art. Plain white background, perfect for a clothing design mockup.`; break; case 'sketch-european': prompt = `Full body fashion illustration of an elegant European model in a ${getRandomElement(sketchPoses)}. Sophisticated, fluid, and artistic line art. Plain white background, perfect for a clothing design mockup.`; break; case 'photo-asian': prompt = `Ultra-photorealistic full body photo of a professional young Asian female fashion model, ${getRandomElement(photoPoses)}, ${getRandomElement(photoExpressions)}. Plain studio background, professional lighting, ${getRandomElement(photoLenses)}.`; break; case 'photo-black': prompt = `Ultra-photorealistic full body photo of a professional young Black female fashion model, ${getRandomElement(photoPoses)}, ${getRandomElement(photoExpressions)}. Plain studio background, professional lighting, ${getRandomElement(photoLenses)}.`; break; case 'photo-european': prompt = `Ultra-photorealistic full body photo of a professional young Caucasian female fashion model, ${getRandomElement(photoPoses)}, ${getRandomElement(photoExpressions)}. Plain studio background, professional lighting, ${getRandomElement(photoLenses)}.`; break; } return prompt; }
    const vocabData = { 'æ¬¾å¼ç±»åˆ«': { 'Tæ¤': 'T-shirt', 'è¿è¡£è£™': 'Dress', 'å¤¹å…‹': 'Jacket', 'é£è¡£': 'Trench coat', 'å«è¡£': 'Hoodie', 'è£¤å­': 'Pants', 'åŠèº«è£™': 'Skirt', 'è¥¿è£…': 'Blazer', 'è¡¬è¡«': 'Shirt', 'æ¯›è¡£': 'Sweater' }, 'è®¾è®¡é£æ ¼': { 'èµ›åšæœ‹å…‹': 'Cyberpunk', 'å“¥ç‰¹': 'Gothic', 'å¤å¤': 'Vintage', 'æç®€ä¸»ä¹‰': 'Minimalist', 'è¡—å¤´æ½®æµ': 'Streetwear', 'æ³¢è¥¿ç±³äºš': 'Bohemian', 'å­¦é™¢é£': 'Preppy', 'è¿åŠ¨ä¼‘é—²': 'Athleisure', 'æœªæ¥ä¸»ä¹‰': 'Futuristic', 'åºŸåœŸé£': 'Post-apocalyptic' }, 'é¢æ–™æè´¨': { 'ä¸ç»¸': 'Silk', 'ç‰›ä»”å¸ƒ': 'Denim', 'çš®é©': 'Leather', 'æ£‰å¸ƒ': 'Cotton', 'ç¾Šæ¯›': 'Wool', 'ç§‘æŠ€é¢æ–™': 'Techwear fabric', 'é›ªçºº': 'Chiffon', 'å¤©é¹…ç»’': 'Velvet', 'ç½‘çº±': 'Mesh', 'åå…‰ææ–™': 'Reflective material' }, 'å›¾æ¡ˆå°èŠ±': { 'æ ¼çº¹': 'Plaid', 'æ¡çº¹': 'Stripes', 'èŠ±å‰': 'Floral print', 'æŠ½è±¡å‡ ä½•': 'Abstract geometric pattern', 'åŠ¨ç‰©çº¹': 'Animal print', 'æ‰æŸ“': 'Tie-dye', 'çº¯è‰²': 'Solid color', 'logoå°èŠ±': 'Logo print' }, 'ç»†èŠ‚å‰ªè£': { 'ä¸å¯¹ç§°': 'Asymmetrical cut', 'é«˜è…°': 'High-waisted', 'å¤šå£è¢‹': 'Multiple pockets', 'æ‹‰é“¾': 'Zippers', 'å®½æ¾ç‰ˆå‹': 'Oversized fit', 'ä¿®èº«ç‰ˆå‹': 'Slim fit', 'è·å¶è¾¹': 'Ruffles', 'æµè‹': 'Fringes', 'é•‚ç©º': 'Cut-out details', 'æ‹¼æ¥': 'Patchwork' }, 'è‰²å½©æ­é…': { 'è«å…°è¿ªè‰²ç³»': 'Morandi color palette', 'éœ“è™¹è‰²': 'Neon colors', 'é»‘ç™½ç°': 'Monochromatic black and white', 'å¤§åœ°è‰²ç³»': 'Earth tones', 'æ’è‰²': 'Color blocking', 'æ¸å˜è‰²': 'Gradient colors' } };
    function createVocabButtons() { const containers = { 'æ¬¾å¼ç±»åˆ«': document.getElementById('style-type-buttons'), 'è®¾è®¡é£æ ¼': document.getElementById('aesthetic-buttons'), 'é¢æ–™æè´¨': document.getElementById('material-buttons'), 'å›¾æ¡ˆå°èŠ±': document.getElementById('pattern-buttons'), 'ç»†èŠ‚å‰ªè£': document.getElementById('details-buttons'), 'è‰²å½©æ­é…': document.getElementById('color-buttons') }; for (const category in vocabData) { const container = containers[category]; if (!container) continue; for (const term in vocabData[category]) { const button = createButton(term); container.appendChild(button); } } }
    function createButton(chineseTerm) { const button = document.createElement('button'); button.textContent = chineseTerm; button.className = 'px-4 py-2 text-sm font-medium rounded-full bg-gray-100 hover:bg-indigo-100 text-gray-700 hover:text-indigo-700 transition-colors'; button.onclick = () => { let currentText = promptInput.value.trim(); const termToAdd = button.textContent; if (currentText && currentText.length > 0) { promptInput.value += `, ${termToAdd}`; } else { promptInput.value = termToAdd; } promptInput.dispatchEvent(new Event('input')); }; return button; }
    function toggleCategoryButtons(targetId) { const element = document.getElementById(targetId); if(element) { element.classList.toggle('hidden'); } }
    function getApiUsage() { const usage = localStorage.getItem(USAGE_STORAGE_KEY); return usage ? JSON.parse(usage) : { date: new Date().toISOString().split('T')[0], count: 0 }; }
    function updateUsageCounterUI() { const usage = getApiUsage(); const today = new Date().toISOString().split('T')[0]; let remaining = (usage.date === today) ? DAILY_API_LIMIT - usage.count : DAILY_API_LIMIT; remaining = Math.max(0, remaining); apiUsageCounter.textContent = remaining; apiUsageCounter.classList.toggle('text-red-600', remaining <= 0); apiUsageCounter.classList.toggle('font-bold', remaining <= 0); }
    function checkApiLimit() { let usage = getApiUsage(); const today = new Date().toISOString().split('T')[0]; if (usage.date !== today) { localStorage.setItem(USAGE_STORAGE_KEY, JSON.stringify({ date: today, count: 0 })); updateUsageCounterUI(); return true; } if (usage.count >= DAILY_API_LIMIT) { showErrorMessage(`æ‚¨å·²è¾¾åˆ°ä»Šæ—¥ ${DAILY_API_LIMIT} æ¬¡çš„ä½¿ç”¨ä¸Šé™ï¼Œè¯·æ˜å¤©å†æ¥ã€‚`); return false; } return true; }
    function incrementApiUsage() { let usage = getApiUsage(); const today = new Date().toISOString().split('T')[0]; usage.count = (usage.date === today) ? usage.count + 1 : 1; usage.date = today; localStorage.setItem(USAGE_STORAGE_KEY, JSON.stringify(usage)); updateUsageCounterUI(); }
    function showErrorMessage(message) { mainLoadingContainer.classList.add('hidden'); detailLoadingContainer.classList.add('hidden'); i2iLoadingContainer.classList.add('hidden'); lineartLoadingContainer.classList.add('hidden'); lineartUploadLoadingContainer.classList.add('hidden'); errorMessage.classList.remove('hidden'); errorText.textContent = `é”™è¯¯: ${message}`; }
    function addDownloadButton(containerElement, base64Data, filename) { if (!containerElement) return; let downloadLink = containerElement.querySelector('.download-btn'); if (!downloadLink) { downloadLink = document.createElement('a'); downloadLink.className = 'download-btn absolute bottom-2 right-2 p-2 bg-black bg-opacity-50 rounded-full hover:bg-opacity-75 transition-opacity z-10'; downloadLink.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>`; containerElement.appendChild(downloadLink); } downloadLink.href = `data:image/png;base64,${base64Data}`; downloadLink.download = filename; }
    async function getEnglishTranslation(chineseText, context = "fashion design term") { if (!checkApiLimit()) return null; const payload = { contents: [{ parts: [{ text: `Translate the following Chinese ${context} into English. IMPORTANT: Respond with ONLY the translated text, without any introductory phrases, explanations, or quotation marks. Chinese text: "${chineseText}"` }] }] }; const response = await fetchWithRetry(GEMINI_API_URL, { method: 'POST', body: JSON.stringify(payload) }); incrementApiUsage(); return response?.candidates?.[0]?.content?.parts?.[0]?.text?.trim().replace(/["'.]/g, '') || null;}
    async function generateImageFromPrompt(prompt, loadingText) { mainLoadingContainer.querySelector('p').textContent = loadingText; mainLoadingContainer.classList.remove('hidden'); [refineBtn, generateBtn, storyBtn, detailBtn, lineartBtn, generateModelBtn].forEach(btn => btn.disabled = true); storyContainer.classList.add('hidden'); detailImage.classList.add('hidden'); generatedImage.classList.add('hidden'); currentImageData = null; storyButtonsContainer.classList.add('hidden'); modelModificationContainer.classList.add('hidden'); modifyModelInputArea.classList.add('hidden'); try { const payload = { contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseModalities: ["IMAGE"] }, }; const response = await fetchWithRetry(IMAGE_GENERATION_API_URL, { method: 'POST', body: JSON.stringify(payload) }); incrementApiUsage(); const base64Data = response?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data; if (base64Data) { generatedImage.src = `data:image/png;base64,${base64Data}`; generatedImage.classList.remove('hidden'); addDownloadButton(imageContainer, base64Data, 'generated-image.png'); currentImageData = base64Data; if (loadingText.includes('æ¨¡ç‰¹')) { modelModificationContainer.classList.remove('hidden'); } else if (loadingText.includes('æ‹æ‘„')) { storyBtn.disabled = false; detailBtn.disabled = false; storyButtonsContainer.classList.remove('hidden'); storyPromptInput.value = `è¯·æ ¹æ®è¿™å¼ æœè£…è®¾è®¡å›¾ï¼Œç»“åˆæœ€åˆçš„è®¾è®¡ç†å¿µ "${promptInput.value.trim()}"ï¼Œæ’°å†™ä¸€æ®µä¸“ä¸šã€å¸å¼•äººçš„è®¾è®¡è¯´æ˜ã€‚`; } } else { showErrorMessage("å›¾ç‰‡ç”Ÿæˆå¤±è´¥æˆ–å†…å®¹è¢«æ‹¦æˆªã€‚"); } } catch (error) { showErrorMessage(error.message); } finally { mainLoadingContainer.classList.add('hidden'); [refineBtn, generateBtn, lineartBtn, generateModelBtn].forEach(btn => btn.disabled = false); generateBtn.disabled = !promptInput.value.trim().length; } }
    async function generateStory() { if (!currentImageData || !checkApiLimit()) return; storyContainer.classList.remove('hidden'); storyText.textContent = 'æ­£åœ¨ç”Ÿæˆè®¾è®¡è¯´æ˜...'; document.getElementById('story-action-buttons').classList.add('hidden'); storyBtn.disabled = true; detailBtn.disabled = true; try { const userInstruction = storyPromptInput.value.trim() || `è¯·æ ¹æ®è¿™å¼ æœè£…è®¾è®¡å›¾ï¼Œç»“åˆæœ€åˆçš„è®¾è®¡ç†å¿µ "${promptInput.value.trim()}"ï¼Œæ’°å†™ä¸€æ®µä¸“ä¸šã€å¸å¼•äººçš„è®¾è®¡è¯´æ˜ã€‚è¯·åªç”¨ä¸­æ–‡å›ç­”ã€‚`; const payload = { contents: [{ role: "user", parts: [{ text: userInstruction }, { inlineData: { mimeType: "image/png", data: currentImageData } }] }] }; const response = await fetchWithRetry(GEMINI_API_URL, { method: 'POST', body: JSON.stringify(payload) }); incrementApiUsage(); const storyContent = response?.candidates?.[0]?.content?.parts?.[0]?.text; if (storyContent) { storyText.textContent = storyContent; document.getElementById('story-action-buttons').classList.remove('hidden'); } else { storyText.textContent = `ç”Ÿæˆè¯´æ˜å¤±è´¥ï¼Œæœªæ”¶åˆ°æœ‰æ•ˆå†…å®¹ã€‚`; } } catch (error) { storyText.textContent = `ç”Ÿæˆè¯´æ˜å¤±è´¥: ${error.message}`; } finally { storyBtn.disabled = false; detailBtn.disabled = false; } }
    async function generateModifiedImage(prompt, loadingMessageText = 'æ­£åœ¨ç”Ÿæˆä¿®æ”¹å›¾...') { if (!currentImageData || !checkApiLimit()) return; detailLoadingContainer.querySelector('p').textContent = loadingMessageText; detailLoadingContainer.classList.remove('hidden'); detailImage.classList.add('hidden'); const finalPrompt = `Based on the provided image, modify it according to the following instruction: "${prompt}"`; const payload = { contents: [{ role: "user", parts: [{ text: finalPrompt }, { inlineData: { mimeType: "image/png", data: currentImageData } }] }], generationConfig: { responseModalities: ["IMAGE"] }, }; try { const response = await fetchWithRetry(IMAGE_GENERATION_API_URL, { method: 'POST', body: JSON.stringify(payload) }); incrementApiUsage(); const base64Data = response?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data; if (base64Data) { detailImage.src = `data:image/png;base64,${base64Data}`; detailImage.classList.remove('hidden'); addDownloadButton(detailImage.parentElement, base64Data, 'modified-image.png'); } else { showErrorMessage("ä¿®æ”¹å›¾ç”Ÿæˆå¤±è´¥ã€‚"); } } catch (error) { showErrorMessage(error.message); } finally { detailLoadingContainer.classList.add('hidden'); } }
    function handleI2IFileUpload(file, type, previewElement, containerElement, inputElement) { if (!file) return; const reader = new FileReader(); reader.onload = (e) => { const base64String = e.target.result.split(',')[1]; const label = inputElement.parentElement; if (type === 'model') { uploadedModelData = base64String; label.classList.add('has-image'); } else if (type === 'garment') { uploadedGarmentData = base64String; label.classList.add('has-image'); } else if (type === 'lineart') { uploadedLineartImageData = base64String; lineartUploadModificationContainer.classList.remove('hidden'); lineartUploadGeneratedImageContainer.classList.add('hidden'); } previewElement.src = e.target.result; containerElement.classList.remove('hidden'); label.querySelector('span').textContent = "æ›´æ¢å›¾ç‰‡"; if (uploadedModelData && uploadedGarmentData) { tryOnBtn.disabled = false; } }; reader.readAsDataURL(file); }
    async function performTryOn(userPrompt = '') { if (!uploadedModelData || !uploadedGarmentData || !checkApiLimit()) return; i2iLoadingContainer.querySelector('p').textContent = 'æ­£åœ¨ç”Ÿæˆç©¿æ­æ•ˆæœå›¾...'; i2iLoadingContainer.classList.remove('hidden'); i2iGeneratedImage.classList.add('hidden'); modifyTryOnBtn.classList.add('hidden'); generateCopyBtn.classList.add('hidden'); i2iBeforeContainer.classList.add('hidden'); copyDisplayContainer.classList.add('hidden'); try { let finalTryOnPrompt = `You are a professional virtual try-on assistant. In the provided images, one is a model and the other is a piece of clothing. Your task is to accurately place the clothing onto the model. IMPORTANT: If the garment image appears to be a sketch, line art, or drawing, first interpret and render it as a photorealistic object. Then, seamlessly integrate this realistic garment onto the model, ensuring correct scale, perspective, lighting, and shadows for a natural, photorealistic final composite. The image with the person is the model.`; if (userPrompt) { finalTryOnPrompt += ` Additionally, apply the following details: "${userPrompt}"`; } const payload = { contents: [{ role: "user", parts: [ { text: finalTryOnPrompt }, { inlineData: { mimeType: "image/jpeg", data: uploadedModelData } }, { inlineData: { mimeType: "image/jpeg", data: uploadedGarmentData } } ] }], generationConfig: { responseModalities: ["IMAGE"] }, }; const response = await fetchWithRetry(IMAGE_GENERATION_API_URL, { method: 'POST', body: JSON.stringify(payload) }); incrementApiUsage(); const base64Data = response?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data; if (base64Data) { originalTryOnResultData = base64Data; currentTryOnResultData = base64Data; i2iGeneratedImage.src = `data:image/png;base64,${base64Data}`; i2iGeneratedImageContainer.classList.remove('hidden'); i2iGeneratedImage.classList.remove('hidden'); modifyTryOnBtn.classList.remove('hidden'); addDownloadButton(i2iAfterContainer, base64Data, 'try-on-result.png'); } else { showErrorMessage("ç”Ÿæˆæ•ˆæœå›¾å¤±è´¥ã€‚"); } } catch (error) { showErrorMessage(error.message); } finally { i2iLoadingContainer.classList.add('hidden'); } }
    async function performModification() { const modificationPrompt = modifyTryOnInput.value.trim(); if (!modificationPrompt || !originalTryOnResultData || !checkApiLimit()) return; modifyTryOnModal.classList.add('hidden'); i2iLoadingContainer.querySelector('p').textContent = 'æ­£åœ¨ä¿®æ”¹æ•ˆæœå›¾...'; i2iLoadingContainer.classList.remove('hidden'); i2iGeneratedImage.classList.add('hidden'); try { const finalPrompt = `Based on the provided image of a model wearing a garment, modify it according to the following instruction: "${modificationPrompt}"`; const payload = { contents: [{ role: "user", parts: [{ text: finalPrompt }, { inlineData: { mimeType: "image/png", data: originalTryOnResultData } }] }], generationConfig: { responseModalities: ["IMAGE"] }, }; const response = await fetchWithRetry(IMAGE_GENERATION_API_URL, { method: 'POST', body: JSON.stringify(payload) }); incrementApiUsage(); const base64Data = response?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data; if (base64Data) { i2iBeforeImage.src = `data:image/png;base64,${originalTryOnResultData}`; addDownloadButton(i2iBeforeContainer, originalTryOnResultData, 'try-on-original.png'); i2iBeforeContainer.classList.remove('hidden'); currentTryOnResultData = base64Data; i2iGeneratedImage.src = `data:image/png;base64,${base64Data}`; addDownloadButton(i2iAfterContainer, base64Data, 'try-on-modified.png'); generateCopyBtn.classList.remove('hidden'); modifyTryOnInput.value = ''; } else { showErrorMessage("ä¿®æ”¹å¤±è´¥ã€‚"); } } catch (error) { showErrorMessage(error.message); } finally { i2iLoadingContainer.classList.add('hidden'); i2iGeneratedImage.classList.remove('hidden');} }
    async function performGenerateCopy() { if (!currentTryOnResultData || !checkApiLimit()) return; generateCopyModal.classList.add('hidden'); i2iLoadingContainer.querySelector('p').textContent = 'æ­£åœ¨ç”Ÿæˆæ–‡æ¡ˆ...'; i2iLoadingContainer.classList.remove('hidden'); copyDisplayContainer.classList.add('hidden'); try { const userInput = generateCopyInput.value.trim(); const prompt = `è¯·æ ¹æ®è¿™å¼ å›¾ç‰‡ï¼Œæ’°å†™ä¸€æ®µæ¨å¹¿æ–‡æ¡ˆã€‚æ–‡æ¡ˆè¦æ±‚å¦‚ä¸‹ï¼š'${userInput}'ã€‚å¦‚æœæ²¡æœ‰è¦æ±‚ï¼Œè¯·è‡ªç”±å‘æŒ¥ï¼Œä¾‹å¦‚åˆ›ä½œä¸€æ®µå°çº¢ä¹¦é£æ ¼çš„æ–‡æ¡ˆã€‚è¯·åªç”¨ä¸­æ–‡å›ç­”ã€‚`; const payload = { contents: [{ role: "user", parts: [{ text: prompt }, { inlineData: { mimeType: "image/png", data: currentTryOnResultData } }] }] }; const response = await fetchWithRetry(GEMINI_API_URL, { method: 'POST', body: JSON.stringify(payload) }); incrementApiUsage(); const copyContent = response?.candidates?.[0]?.content?.parts?.[0]?.text; if (copyContent) { generatedCopyText.textContent = copyContent; copyDisplayContainer.classList.remove('hidden'); } else { showErrorMessage("æ–‡æ¡ˆç”Ÿæˆå¤±è´¥ã€‚"); } generateCopyInput.value = ''; } catch(error) { showErrorMessage(error.message); } finally { i2iLoadingContainer.classList.add('hidden'); } }
    async function handleUploadedLineartModify() { const prompt = lineartUploadModificationPrompt.value.trim(); if (!prompt || !uploadedLineartImageData) { showErrorMessage("è¯·å…ˆä¸Šä¼ å›¾ç‰‡å¹¶è¾“å…¥ä¿®æ”¹æŒ‡ä»¤ã€‚"); return; } if (!checkApiLimit()) return; lineartUploadLoadingContainer.classList.remove('hidden'); lineartUploadGeneratedImageContainer.classList.add('hidden'); const modifyPrompt = `Based on the provided image, redraw it with the following modification: "${prompt}"`; const payload = { contents: [{ role: "user", parts: [ { text: modifyPrompt }, { inlineData: { mimeType: "image/png", data: uploadedLineartImageData } } ] }], generationConfig: { responseModalities: ["IMAGE"] }, }; try { const response = await fetchWithRetry(IMAGE_GENERATION_API_URL, { method: 'POST', body: JSON.stringify(payload) }); incrementApiUsage(); const base64Data = response?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data; if (base64Data) { const imageUrl = `data:image/png;base64,${base64Data}`; lineartUploadGeneratedImage.src = imageUrl; lineartUploadGeneratedImageContainer.classList.remove('hidden'); addDownloadButton(lineartUploadGeneratedImageContainer, base64Data, 'lineart-upload-modified.png'); } else { showErrorMessage('ç”Ÿæˆæ–°å›¾ç‰‡å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚'); } } catch (error) { showErrorMessage(`ç”Ÿæˆå¤±è´¥: ${error.message}`); } finally { lineartUploadLoadingContainer.classList.add('hidden'); } }
    async function handleLineartModify(prompt) { if (!prompt || !currentLineArtData || !checkApiLimit()) return; const modifiedWrapper = document.getElementById('lineart-modified-wrapper'); modifiedWrapper.innerHTML = `<div class="text-center py-8"><div class="spinner"></div><p class="mt-2 text-sm font-medium text-gray-600">æ­£åœ¨æ¶¦è‰²...</p></div>`; const modifyPrompt = `Based on the provided fashion line art, redraw it with the following modification: "${prompt}"`; const payload = { contents: [{ role: "user", parts: [{ text: modifyPrompt }, { inlineData: { mimeType: "image/png", data: currentLineArtData } }] }], generationConfig: { responseModalities: ["IMAGE"] }, }; try { const response = await fetchWithRetry(IMAGE_GENERATION_API_URL, { method: 'POST', body: JSON.stringify(payload) }); incrementApiUsage(); const base64Data = response?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data; if (base64Data) { const imageUrl = `data:image/png;base64,${base64Data}`; modifiedWrapper.innerHTML = `<img src="${imageUrl}" class="max-w-full h-auto mx-auto rounded-lg shadow-md" alt="Modified Line Art">`; addDownloadButton(modifiedWrapper, base64Data, 'lineart-modified.png'); } else { showErrorMessage('æ¶¦è‰²å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚'); modifiedWrapper.innerHTML = ''; } } catch (error) { showErrorMessage(`æ¶¦è‰²å¤±è´¥: ${error.message}`); modifiedWrapper.innerHTML = ''; } }
    async function handleEncyclopediaSearch() { const query = encyclopediaInput.value.trim(); if (!query || !checkApiLimit()) return; encyclopediaLoading.classList.remove('hidden'); encyclopediaResults.innerHTML = ''; try { const payload = { contents: [{ parts: [{ text: `Use Google Search to find information about the fashion term "${query}" and provide a concise summary. Respond in Chinese.` }] }], tools: [{ "google_search": {} }]}; const response = await fetchWithRetry(GEMINI_API_URL, { method: 'POST', body: JSON.stringify(payload) }); incrementApiUsage(); const encyclopediaContent = response?.candidates?.[0]?.content?.parts?.[0]?.text; if (encyclopediaContent) { encyclopediaResults.innerHTML = `<p class="text-gray-700">${encyclopediaContent.replace(/\n/g, '<br>')}</p>`; } else { encyclopediaResults.innerHTML = `<p class="text-center text-gray-500">æœªèƒ½æ£€ç´¢åˆ°ç›¸å…³ä¿¡æ¯ã€‚</p>`; } } catch (error) { showErrorMessage(error.message); } finally { encyclopediaLoading.classList.add('hidden'); } }
    async function handleLineartGeneration() { const query = lineartInput.value.trim(); if (!query || !checkApiLimit()) return; lineartLoadingContainer.classList.remove('hidden'); lineartResults.innerHTML = ''; currentLineArtData = null; try { const englishQuery = await getEnglishTranslation(query, "clothing item"); if (!englishQuery) { showErrorMessage("æ— æ³•ç¿»è¯‘è¾“å…¥å†…å®¹ï¼Œè¯·é‡è¯•ã€‚"); lineartLoadingContainer.classList.add('hidden'); return; } const lineArtStyles = [ `A clean, elegant, minimalist fashion line art of: "${englishQuery}". Focus on flowing, continuous lines and a simple, sophisticated silhouette. Black ink on a pure white background, vector style.`, `A dynamic, energetic fashion sketch of: "${englishQuery}". Emphasize movement with loose, expressive, and sketchy lines. Use cross-hatching for subtle texture. Black pencil on a white background.`, `A detailed, technical yet artistic fashion illustration line drawing of: "${englishQuery}". Precise, clean linework that clearly defines seams, drape, and fabric texture. Presented as a professional technical flat sketch.`, `A bold, graphic-style fashion line art of: "${englishQuery}". Use thick, confident outlines and high contrast. Minimalist details inside the silhouette to focus on the overall shape. Looks like a modern vector icon.` ]; const lineArtPrompt = getRandomElement(lineArtStyles); const payload = { contents: [{ parts: [{ text: lineArtPrompt }] }], generationConfig: { responseModalities: ["IMAGE"] }, }; const response = await fetchWithRetry(IMAGE_GENERATION_API_URL, { method: 'POST', body: JSON.stringify(payload) }); incrementApiUsage(); const base64Data = response?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data; if (base64Data) { currentLineArtData = base64Data; const imageUrl = `data:image/png;base64,${base64Data}`; lineartResults.innerHTML = ` <div class="flex flex-col gap-4 items-center"> <div id="lineart-original-wrapper" class="relative"> <img src="${imageUrl}" class="max-w-full h-auto mx-auto rounded-lg shadow-md" alt="Original Line Art"> </div> <div id="lineart-modified-wrapper" class="relative"></div> </div> <div id="lineart-controls" class="mt-4 flex flex-col sm:flex-row justify-center items-center gap-4"> <div class="relative"> <button id="lineart-modify-btn" class="px-6 py-2 text-white font-bold rounded-full shadow-lg btn btn-quintenary"> <span>æ¶¦è‰² ğŸ¨</span> </button> <div id="lineart-modify-options" class="absolute bottom-full mb-2 w-max bg-white rounded-md shadow-lg z-10 hidden text-left"> <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 font-bold" data-detail-prompt="custom">æ›´å¤šç»†èŠ‚... (æ‰‹åŠ¨è¾“å…¥)</a> <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-detail-prompt="Color this line art with a simple, flat color palette.">ä¸€é”®ä¸Šè‰²</a> <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-detail-prompt="Redraw this in a more minimalist, simplified style.">æ›´æç®€</a> <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-detail-prompt="Redraw this with more intricate and exquisite details.">æ›´ç²¾è‡´</a> </div> </div> </div> `; addDownloadButton(document.getElementById('lineart-original-wrapper'), base64Data, 'lineart-original.png'); document.getElementById('lineart-modify-btn').addEventListener('click', () => { document.getElementById('lineart-modify-options').classList.toggle('hidden'); }); document.getElementById('lineart-modify-options').addEventListener('click', (event) => { event.preventDefault(); if (event.target.tagName !== 'A') return; const detailPrompt = event.target.dataset.detailPrompt; document.getElementById('lineart-modify-options').classList.add('hidden'); if (detailPrompt === 'custom') { lineartCustomDetailModal.classList.remove('hidden'); } else { handleLineartModify(detailPrompt); } }); } else { lineartResults.innerHTML = `<p class="text-center text-gray-500">æ— æ³•ç”Ÿæˆçº¿ç¨¿ï¼Œè¯·å°è¯•å…¶ä»–å…³é”®è¯ã€‚</p>`; } } catch (error) { lineartResults.innerHTML = `<p class="text-center text-red-500">ç”Ÿæˆå¤±è´¥ï¼š${error.message}</p>`; } finally { lineartLoadingContainer.classList.add('hidden'); } }

    // --- Event Listeners Setup ---
    function setupEventListeners() {
        createVocabButtons();
        updateUsageCounterUI();
        notebookTextarea.value = localStorage.getItem('fashionNotebookContent') || '';
        document.querySelectorAll('#vocab-modal h4[data-target]').forEach(title => { title.addEventListener('click', () => toggleCategoryButtons(title.dataset.target)); });
        lineartUploadInput.addEventListener('change', (e) => handleI2IFileUpload(e.target.files[0], 'lineart', lineartUploadPreview, lineartUploadPreviewContainer, e.target));
        promptInput.addEventListener('input', () => generateBtn.disabled = !promptInput.value.trim().length);
        generateBtn.addEventListener('click', async () => { 
            mainLoadingContainer.querySelector('p').textContent = 'æ­£åœ¨ç¿»è¯‘æè¿°...';
            mainLoadingContainer.classList.remove('hidden');
            generatedImage.classList.add('hidden');
            [refineBtn, generateBtn, lineartBtn, generateModelBtn].forEach(btn => btn.disabled = true);
            try { 
                const englishText = await getEnglishTranslation(promptInput.value.trim(), "fashion design concept");
                if (englishText) { 
                    const photoStyles = [
                        `Professional high-resolution product photography of a ${englishText}, studio lighting, plain background.`,
                        `A full-body, professional fashion photoshoot of a model wearing a ${englishText}, studio lighting, plain background.`
                    ];
                    const finalPrompt = getRandomElement(photoStyles);
                    await generateImageFromPrompt(finalPrompt, 'AI æ‘„å½±å¸ˆæ­£åœ¨æ‹æ‘„ä¸­...'); 
                } 
                else { 
                    showErrorMessage("æ— æ³•ç¿»è¯‘æ‚¨çš„è¾“å…¥ï¼Œè¯·æ£€æŸ¥å†…å®¹æˆ–ç¨åé‡è¯•ã€‚");
                    mainLoadingContainer.classList.add('hidden');
                    [refineBtn, generateBtn, lineartBtn, generateModelBtn].forEach(btn => btn.disabled = false);
                    generateBtn.disabled = !promptInput.value.trim().length;
                }
            } catch(e) { 
                showErrorMessage(e.message); 
                mainLoadingContainer.classList.add('hidden');
                [refineBtn, generateBtn, lineartBtn, generateModelBtn].forEach(btn => btn.disabled = false);
                generateBtn.disabled = !promptInput.value.trim().length;
            } 
        });
        generateModelBtn.addEventListener('click', () => modelOptions.classList.toggle('hidden'));
        modelOptions.addEventListener('click', (e) => { e.preventDefault(); if (e.target.tagName === 'A' && e.target.dataset.modelType) { modelOptions.classList.add('hidden'); generateImageFromPrompt(generateRandomizedModelPrompt(e.target.dataset.modelType), 'æ­£åœ¨ç”Ÿæˆå¤šæ ·åŒ–æ¨¡ç‰¹...'); } });
        customModelBtn.addEventListener('click', (e) => { e.preventDefault(); modelOptions.classList.add('hidden'); customModelModal.classList.remove('hidden'); });
        closeCustomModelBtn.addEventListener('click', () => customModelModal.classList.add('hidden'));
        submitCustomModelBtn.addEventListener('click', () => { const customPrompt = `Full body shot of a fashion model with the following characteristics: ${customModelInput.value.trim()}. Standing pose, studio lighting, plain background.`; if (customModelInput.value.trim()) { customModelModal.classList.add('hidden'); generateImageFromPrompt(customPrompt, 'æ­£åœ¨ç”Ÿæˆè‡ªå®šä¹‰æ¨¡ç‰¹...'); customModelInput.value = ''; } });
        storyBtn.addEventListener('click', generateStory);
        detailBtn.addEventListener('click', () => detailOptions.classList.toggle('hidden'));
        detailOptions.addEventListener('click', (e) => { e.preventDefault(); if (e.target.tagName === 'A') { const prompt = e.target.dataset.detailPrompt; detailOptions.classList.add('hidden'); prompt === 'custom' ? customDetailModal.classList.remove('hidden') : generateModifiedImage(prompt, 'æ­£åœ¨æ·±åŒ–è®¾è®¡ç»†èŠ‚...'); } });
        closeCustomModalBtn.addEventListener('click', () => customDetailModal.classList.add('hidden'));
        submitCustomDetailBtn.addEventListener('click', () => { if (customDetailInput.value.trim()) { customDetailModal.classList.add('hidden'); generateModifiedImage(customDetailInput.value.trim(), 'æ­£åœ¨æ·±åŒ–è®¾è®¡ç»†èŠ‚...'); customDetailInput.value = ''; } else { showErrorMessage("è¯·è¾“å…¥ä¿®æ”¹æŒ‡ä»¤ã€‚"); } });
        showModifyModelInputBtn.addEventListener('click', () => { modifyModelInputArea.classList.toggle('hidden'); });
        submitModelModificationBtn.addEventListener('click', () => { if (modifyModelPrompt.value.trim()) { generateModifiedImage(modifyModelPrompt.value.trim()); } });
        i2iModelUploadInput.addEventListener('change', (e) => handleI2IFileUpload(e.target.files[0], 'model', i2iModelPreview, i2iModelPreviewContainer, e.target));
        i2iGarmentUploadInput.addEventListener('change', (e) => handleI2IFileUpload(e.target.files[0], 'garment', i2iGarmentPreview, i2iGarmentPreviewContainer, e.target));
        tryOnBtn.addEventListener('click', () => tryOnPromptModal.classList.remove('hidden'));
        closeTryOnPromptModalBtn.addEventListener('click', () => tryOnPromptModal.classList.add('hidden'));
        submitTryOnPromptBtn.addEventListener('click', () => { tryOnPromptModal.classList.add('hidden'); performTryOn(tryOnPromptInput.value.trim()); });
        modifyTryOnBtn.addEventListener('click', () => modifyTryOnModal.classList.remove('hidden'));
        closeModifyTryOnModalBtn.addEventListener('click', () => modifyTryOnModal.classList.add('hidden'));
        submitModifyTryOnBtn.addEventListener('click', performModification);
        generateCopyBtn.addEventListener('click', () => generateCopyModal.classList.remove('hidden'));
        closeGenerateCopyModalBtn.addEventListener('click', () => generateCopyModal.classList.add('hidden'));
        submitGenerateCopyBtn.addEventListener('click', performGenerateCopy);
        copyGeneratedTextBtn.addEventListener('click', () => { navigator.clipboard.writeText(generatedCopyText.textContent).then(() => { const originalText = copyGeneratedTextBtn.textContent; copyGeneratedTextBtn.textContent = 'å·²å¤åˆ¶!'; setTimeout(() => { copyGeneratedTextBtn.textContent = originalText; }, 2000); }); });
        copyStoryBtn.addEventListener('click', () => { navigator.clipboard.writeText(storyText.textContent).then(() => { const originalText = copyStoryBtn.textContent; copyStoryBtn.textContent = 'å·²å¤åˆ¶!'; setTimeout(() => { copyStoryBtn.textContent = originalText; }, 2000); }); });
        goToI2IButton.addEventListener('click', () => { mainPage.classList.add('hidden'); i2iPage.classList.remove('hidden'); });
        goToMainButton.addEventListener('click', () => { i2iPage.classList.add('hidden'); mainPage.classList.remove('hidden'); });
        refineBtn.addEventListener('click', () => { vocabModal.classList.remove('hidden'); });
        closeModalBtn.addEventListener('click', () => { vocabModal.classList.add('hidden'); });
        window.addEventListener('click', function(event) { if (event.target === vocabModal) vocabModal.classList.add('hidden'); if (event.target !== generateModelBtn && !generateModelBtn.contains(event.target)) modelOptions.classList.add('hidden'); });
        notebookToggle.addEventListener('click', () => notebookPanel.classList.toggle('hidden'));
        notebookCopyBtn.addEventListener('click', () => { navigator.clipboard.writeText(notebookTextarea.value).then(() => { const originalText = notebookCopyBtn.textContent; notebookCopyBtn.textContent = 'å·²å¤åˆ¶!'; setTimeout(() => { notebookCopyBtn.textContent = originalText; }, 2000); }); });
        notebookClearBtn.addEventListener('click', () => { notebookTextarea.value = ''; localStorage.setItem('fashionNotebookContent', ''); });
        let saveTimeout;
        notebookTextarea.addEventListener('input', () => { clearTimeout(saveTimeout); saveTimeout = setTimeout(() => { localStorage.setItem('fashionNotebookContent', notebookTextarea.value); notebookStatus.classList.remove('opacity-0'); setTimeout(() => notebookStatus.classList.add('opacity-0'), 2000); }, 500); });
        
        // --- Draggable Notebook Logic ---
        let isDragging = false;
        let offsetX, offsetY;
        notebookHeader.addEventListener('mousedown', (e) => {
            isDragging = true;
            offsetX = e.clientX - notebookPanel.offsetLeft;
            offsetY = e.clientY - notebookPanel.offsetTop;
            notebookPanel.style.transition = 'none'; // Disable transition during drag
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        });

        function onMouseMove(e) {
            if (!isDragging) return;
            const newLeft = e.clientX - offsetX;
            const newTop = e.clientY - offsetY;
            notebookPanel.style.left = `${newLeft}px`;
            notebookPanel.style.top = `${newTop}px`;
        }

        function onMouseUp() {
            isDragging = false;
            notebookPanel.style.transition = ''; // Re-enable transition
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
        }

        encyclopediaToggle.addEventListener('click', () => encyclopediaModal.classList.remove('hidden'));
        closeEncyclopediaModalBtn.addEventListener('click', () => encyclopediaModal.classList.add('hidden'));
        encyclopediaSearchBtn.addEventListener('click', handleEncyclopediaSearch);
        lineartBtn.addEventListener('click', () => { lineartModal.classList.remove('hidden'); });
        closeLineartModalBtn.addEventListener('click', () => { lineartModal.classList.add('hidden'); });
        lineartGenerateBtn.addEventListener('click', handleLineartGeneration);
        lineartCloseCustomModalBtn.addEventListener('click', () => lineartCustomDetailModal.classList.add('hidden'));
        lineartSubmitCustomDetailBtn.addEventListener('click', () => { const customPrompt = lineartCustomDetailInput.value.trim(); if (customPrompt) { lineartCustomDetailModal.classList.add('hidden'); handleLineartModify(customPrompt); lineartCustomDetailInput.value = ''; } else { showErrorMessage("è¯·è¾“å…¥ä¿®æ”¹æŒ‡ä»¤ã€‚"); } });
        lineartUploadModifyBtn.addEventListener('click', handleUploadedLineartModify);

        // --- NEW: Initial App Logic ---
        function initializeApp() {
            setupEventListeners();
            const token = localStorage.getItem('userToken');
            if (token) {
                // Assume token is valid, hide login. 
                // The fetcher will force re-login if it's invalid.
                hideLogin();
            } else {
                showLogin();
            }
        }

        // Start the application
        initializeApp();
    </script>
</body>
</html>
